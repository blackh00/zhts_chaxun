<?php/***功能：手机号码信息的搜素*作者：yumao*联系方式:QQ:916564404*创建时间:2013/3/26**/class PhoneSearchAction extends Action{		/*
	 * 所有action默认调用的方法
	 */
	function _initialize(){
		// 获取当前客户端ip
		$ip = get_client_ip();
		$this->assign("ip",$ip);		$this->assign("flag","shenghuo");				$this->assign("headInfo", setHead()); // 设置页面头部信息
	}	
	/*	 *手机信息的显示，搜素	 */	public function index(){		header("Content-Type:text/html;charset=utf-8");				// 用来标志是否在模版页面尾部要包含另外的js		$this->assign("footerFlag",1); // 1表示包含		// 得到用户从生活分类页面输入的手机号码值		if($_REQUEST['phoneNum']){			$phoneNum = $_REQUEST['phoneNum'];		}		if($phoneNum){			// 过滤掉不合法手机号码			if(preg_match('/^((\+86-)|(86-))?(13[0-9]|15[0-9]|18[0-9]|147)\d{8}$/',$phoneNum)){				$mobileInfo = $this->dealData($phoneNum);				if($mobileInfo){									// 把手机号码相关信息分配到前台模版					$mobileInfo['MobileNumber'] = $phoneNum; 					$this->assign('mobileInfo',$mobileInfo);					} else {										// 如果手机号码信息没有从本地数据库中查询到则调用网上接口查询					$mobileInfoByNetwork = $this->getByNetwork($phoneNum);										// 网数据库中插入数据					$data['MobileArea'] = $mobileInfoByNetwork->province." ".$mobileInfoByNetwork->city;					$data['MobileType'] = $mobileInfoByNetwork->company." ".$mobileInfoByNetwork->card;					$data['PostCode'] = $mobileInfoByNetwork->zip;					$data['AreaCode'] = substr($phoneNum,7);					$mobile->add($data);					$data['MobileNumber'] = $phoneNum; 					// 往模版中分配数据					$this->assign('mobileInfo',$data);									}								// 如果号码没有从自己数据库中查到并且没有从网上接口中得到则提示用户号码不存在，或找不到				if(!$mobileInfo && !$mobileInfoByNetwork){					$this->assign("errorInfo","抱歉！手机号码没找到,请仔细检查是否输入正确");				}			} else {								$returnInfo = "您搜索的电话号码不合法，请仔细检查";				$this->assign('returnInfo',$returnInfo);			}		}		$this -> display();	}	/*	 *手机号码信息的搜素	 */	public function search(){		header("Content-Type:text/html;charset=utf-8");				// 获取回调函数名		$callback = $_REQUEST['callback'];		// 得到电话号码		$phoneNum = $_REQUEST['phoneNum'];		if(preg_match('/^((\+86-)|(86-))?(13[0-9]|15[0-9]|18[0-9]|147)(\d{4,8})$/',$phoneNum)){			$mobileInfo = $this->dealData($phoneNum);			if($mobileInfo){				$mobileInfo['MobileNumber'] = $_REQUEST['phoneNum'];				// 把手机号码相关信息分配到前台模版				$phoneInfo = json_encode($mobileInfo);				echo $callback."($phoneInfo)";				//$this->assign('mobileInfo',$mobileInfo);			} else {				// 如果手机号码信息没有从本地数据库中查询到则调用网上接口查询				$mobileInfoByNetwork = $this->getByNetwork($phoneNum);								// 网数据库中插入数据				if($mobileInfoByNetwork){					$data['MobileArea'] = $mobileInfoByNetwork->province." ".$mobileInfoByNetwork->city;					$data['MobileType'] = $mobileInfoByNetwork->company." ".$mobileInfoByNetwork->card;					$data['PostCode'] = $mobileInfoByNetwork->zip;					$data['AreaCode'] = substr($phoneNum,7);					$mobile->add($data);					$data['MobileNumber'] = $_REQUEST['phoneNum'];					$phoneInfo = json_encode($data);					echo $callback."($phoneInfo)";				} else {					$errorInfo = array("errorNum"=>"2"); // 手机号码没找到或不存在					$phoneInfo = json_encode($errorInfo);					echo $callback."($phoneInfo)";				}			}		}else{			$errorInfo = array("errorNum"=>"1"); // 代表手机号码规则不匹配			$phoneInfo = json_encode($errorInfo);			echo $callback."($phoneInfo)";		}	}		/*	 *调用网上接口查询手机号码函数	 *	 */	private function getByNetwork($phoneNum){	//	$url=C('MOBILE_GET_BY_NET_URL').$phoneNum."&key=".C('MOBILE_GET_BY_NET_KEY');		$shouji_api = C("JUHE_SHOUJI_API");		$url = $shouji_api['UC_API'].$phoneNum."&key=".$shouji_api['UC_KEY'];				// 调用自定义方法通过网络接口查询方法在系统目录下的functions.php文件内		$result = getByNetFun($url);		$returnJson = json_decode($result);		$mobileInfoByNetwork = $returnJson->result;				// 返回相关数据		return $mobileInfoByNetwork;	}		/**	 * post提交数据处理	 */	private function dealData($phoneNum){		// 如果手机号是以+86- 86-开头则把86去掉在查		$phoneNum = ltrim($phoneNum,"+86-");				// 先到本地数据库中查询		// 先截取获取号码的前七个数字组成的字符串		$data['MobileNumber'] = substr($phoneNum,0,7);				// 创建数据库连接对象查询相关信息		$mobile = M('mobile');		$mobileInfo = $mobile->where($data)->find();		return $mobileInfo;	}	/**	* 客服系统 手机归属地 接口	*/	public function kefu_PhoneSearch(){		$phonenum = $_REQUEST['phonenum'];		$phoneinfo = $this->getByNetwork($phonenum);		echo json_encode($phoneinfo);	}}?>